import React, { useRef, useEffect, useState } from "react";
import { useNavigate, useLocation } from "react-router-dom";
import { useDispatch } from "react-redux";
import {
  Box,
  Typography,
  Grid,
  Card,
  CardContent,
  Button,
  Accordion,
  AccordionSummary,
  AccordionDetails,
  ExpandMore,
  List,
  ListItem,
  ListItemIcon,
  ListItemText,
  duration,
  Snackbar,
  Alert,
} from "@mui/material";
import CheckIcon from "@mui/icons-material/Check";
import ExpandMoreIcon from "@mui/icons-material/ExpandMore";
import { refreshUser } from "../../../redux/apiRequest"
import "./UpgradePlan.css";

const plans = [
  {
    id: "proCaNhan",
    title: "GÃ³i Pro CÃ¡ NhÃ¢n",
    price: 199000,
    duration: "30 ngÃ y",
    features: ["ÄÄƒng 10 tin/thÃ¡ng", "Há»— trá»£ Æ°u tiÃªn", "Thá»‘ng kÃª chi tiáº¿t"],
  },
  {
    id: "proDoanhNghiep",
    title: "GÃ³i Pro Doanh Nghiá»‡p",
    price: 499000,
    duration: "30 ngÃ y",
    features: ["ÄÄƒng 50 tin/thÃ¡ng", "Há»— trá»£ 24/7", "Truy xuáº¥t API"],
  },
  {
    id: "proCaoCap",
    title: "GÃ³i Pro Cao Cáº¥p",
    price: 899000,
    duration: "30 ngÃ y",
    features: ["ÄÄƒng khÃ´ng giá»›i háº¡n", "Quáº£n lÃ½ Ä‘á»™i nhÃ³m", "TÆ° váº¥n chiáº¿n lÆ°á»£c"],
  },
];

const postPlans = [
  {
    id: "free3post",
    title: "3 tin miá»…n phÃ­ / thÃ¡ng",
    price: 0,
    features: ["ÄÄƒng tin miá»…n phÃ­ má»—i thÃ¡ng"],
    path: "#",
  },
  {
    id: "additional5post",
    title: "GÃ³i 5 tin",
    price: 50000,
    duration: "30 ngÃ y",
    features: ["ÄÄƒng thÃªm 5 tin"],
  },
  {
    id: "additionalunlimitedpost",
    title: "GÃ³i khÃ´ng giá»›i háº¡n",
    price: 100000,
    duration: "30 ngÃ y",
    features: ["ÄÄƒng khÃ´ng giá»›i háº¡n tin"],
  },
];

const renewPlans = [
  {
    id: "renew7",
    title: "Gia háº¡n 7 ngÃ y",
    price: 10000,
    duration: "7 ngÃ y",
    features: ["Gia háº¡n tin thÃªm 7 ngÃ y"],
  },
  {
    id: "renew15",
    title: "Gia háº¡n 15 ngÃ y",
    price: 18000,
    duration: "15 ngÃ y",
    features: ["Gia háº¡n tin thÃªm 15 ngÃ y"],
  },
  {
    id: "renew30",
    title: "Gia háº¡n 30 ngÃ y",
    price: 30000,
    duration: "30 ngÃ y",
    features: ["Gia háº¡n tin thÃªm 30 ngÃ y"],
  },
];

const vipPlans = [
  {
    id: "vip7",
    title: "Tin VIP 7 ngÃ y",
    price: 50000,
    duration: "7 ngÃ y",
    features: ["Æ¯u tiÃªn tÃ¬m kiáº¿m", "Hiá»ƒn thá»‹ Ä‘áº§u trang"],
  },
  {
    id: "outstanding7",
    title: "Tin Ná»•i báº­t 7 ngÃ y",
    price: 30000,
    duration: "7 ngÃ y",
    features: ["Biá»ƒu tÆ°á»£ng Ä‘áº·c biá»‡t", "Äáº©y Ä‘áº§u chuyÃªn má»¥c"],
  },
  {
    id: "fastpost",
    title: "ÄÄƒng tin nhanh",
    price: 20000,
    features: ["Bá» kiá»ƒm duyá»‡t", "ÄÄƒng ngay láº­p tá»©c"],
  },
];

const seekerPlans = [
  {
    id: "viewphone",
    title: "Xem sá»‘ Ä‘iá»‡n thoáº¡i",
    price: 5000,
    features: ["Hiá»‡n sá»‘ ngÆ°á»i Ä‘Äƒng"],
  },
  {
    id: "unlimitedphone",
    title: "GÃ³i xem khÃ´ng giá»›i háº¡n",
    price: 50000,
    duration: "30 ngÃ y",
    features: ["Xem sá»‘ khÃ´ng giá»›i háº¡n"],
  },
  {
    id: "findroomvip",
    title: "GÃ³i thÃ nh viÃªn tÃ¬m phÃ²ng",
    price: 79000,
    duration: "30 ngÃ y",
    features: ["KhÃ´ng quáº£ng cÃ¡o", "Xem SÄT", "Æ¯u tiÃªn tin má»›i"],
  },
];

const UpgradePlan = () => {
  const navigate = useNavigate();
  const dispatch = useDispatch();
  const location = useLocation();
  const successMessage = location.state?.successMessage;
  const errorMessage = location.state?.errorMessage;
  const [successOpen, setSuccessOpen] = useState(false);
  const [errorOpen, setErrorOpen] = useState(false);
  const handleSelect = (plan) => {
    navigate(
      `/checkout?plan=${plan.id}&title=${encodeURIComponent(plan.title)}&duration=${plan.duration}&features=${plan.features}&price=${plan.price}`
    );
  };

  const plansSectionRef = useRef();

  const handleBuyNow = () => {
    if (plansSectionRef.current) {
      plansSectionRef.current.scrollIntoView({ behavior: "smooth" });
    }
  };

  const renderPlans = (title, plans) => (
    <Accordion
      sx={{
        mb: 2,
        border: "1px solid #e0e0e0",
        borderRadius: 2,
        boxShadow: "0 2px 8px rgba(0,0,0,0.05)",
        "&:before": { display: "none" },
      }}
    >
      <AccordionSummary
        expandIcon={<ExpandMoreIcon />}
        sx={{
          backgroundColor: "#f5f5f5",
          borderBottom: "1px solid #ddd",
          "& .MuiTypography-root": {
            fontWeight: 600,
          },
        }}
      >
        <Typography variant="h6">{title}</Typography>
      </AccordionSummary>
      <AccordionDetails sx={{ backgroundColor: "#e8f5e9", p: 3 }}>
        <Grid container spacing={3}>
          {plans.map((plan, index) => {
            const isGreen = index % 2 === 0;
            const cardBg = isGreen ? "#c8e6c9" : "#ffe0b2";
            const btnBg = isGreen ? "#43a047" : "#fb8c00";
            const btnHover = isGreen ? "#388e3c" : "#ef6c00";

            return (
              <Grid item xs={12} sm={6} md={4} key={plan.title}>
                <Card
                  sx={{
                    height: "100%",
                    display: "flex",
                    flexDirection: "column",
                    justifyContent: "space-between",
                    borderRadius: 2,
                    backgroundColor: cardBg,
                    boxShadow: "0 2px 12px rgba(0, 0, 0, 0.05)",
                    transition: "transform 0.2s",
                    "&:hover": {
                      transform: "scale(1.02)",
                    },
                  }}
                >
                  <CardContent
                    sx={{
                      display: "flex",
                      flexDirection: "column",
                      height: "100%",
                    }}
                  >
                    <Box sx={{ mb: 2 }}>
                      <Typography
                        variant="h6"
                        gutterBottom
                        sx={{ fontWeight: "bold" }}
                      >
                        {plan.title}
                      </Typography>
                      <Typography
                        variant="h4"
                        color="text.primary"
                        sx={{ fontWeight: "bold", mb: 2 }}
                      >
                        {Number(plan.price).toLocaleString()}Ä‘
                      </Typography>

                      <List dense>
                        {plan.features.map((f, i) => (
                          <ListItem key={i} disableGutters sx={{ pl: 0 }}>
                            <ListItemIcon sx={{ minWidth: 28 }}>
                              <CheckIcon fontSize="small" color="success" />
                            </ListItemIcon>
                            <ListItemText primary={f} />
                          </ListItem>
                        ))}
                      </List>
                    </Box>

                    <Box sx={{ mt: "auto" }}>
                      <Button
                        fullWidth
                        variant="contained"
                        size="large"
                        sx={{
                          backgroundColor: btnBg,
                          "&:hover": { backgroundColor: btnHover },
                          borderRadius: 2,
                          fontWeight: "bold",
                        }}
                        onClick={() => handleSelect(plan)}
                      >
                        Chá»n gÃ³i
                      </Button>
                    </Box>
                  </CardContent>
                </Card>
              </Grid>
            );
          })}
        </Grid>
      </AccordionDetails>
    </Accordion>
  );

  useEffect(() => {
    if (successMessage) {
      setSuccessOpen(true);
    }
    if (errorMessage) {
      setErrorOpen(true);
    }
  }, [successMessage, errorMessage]);
  
  useEffect(() => {
    refreshUser(dispatch);
  }, []);  

  return (
    <Box className="upgrade-plan-container">
      {/* Banner giá»›i thiá»‡u gÃ³i Pro */}
      <div className="promo-banner">
        <div className="promo-content">
          <img
            src="https://static.chotot.com/storage/default_images/pty/subscription_landing_page/pty-sub-goi-pro-logo.png"
            width="64"
            height="40"
            alt="goi-pro-logo"
          />
          <p className="promo-text">
            GÃ³i Ä‘Äƒng tin cho mÃ´i giá»›i BÄS chuyÃªn nghiá»‡p - Tiáº¿t kiá»‡m Ä‘áº¿n 86%
          </p>
          <ul className="promo-list">
            <li className="promo-item">
              <div className="promo-icon">âœ“</div>Tiáº¿t kiá»‡m Ä‘áº¿n 86% phÃ­ Ä‘Äƒng tin
            </li>
            <li className="promo-item">
              <div className="promo-icon">âœ“</div>ThÃªm kÃªnh thu hÃºt khÃ¡ch hÃ ng cÃ³
              nhu cáº§u thá»±c
            </li>
            <li className="promo-item">
              <div className="promo-icon">âœ“</div>Quáº£n lÃ½ kinh doanh vÃ  chi tiÃªu
              hiá»‡u quáº£
            </li>
          </ul>
          <div className="promo-buttons">
            <button className="btn btn-primary" onClick={() => handleBuyNow()}>
              Mua ngay
            </button>
            <button
              className="btn btn-outline"
              onClick={() => alert("TÆ° váº¥n thÃªm")}
            >
              TÃ´i cáº§n tÆ° váº¥n
            </button>
          </div>
        </div>
        <div className="promo-image">
          <img
            src="https://static.chotot.com/storage/default_images/pty/subscription_landing_page/pty-sub-value.png"
            alt="goi-pro-img"
          />
        </div>
      </div>

      <div ref={plansSectionRef}>
        <div className="upgrade-title">
          Nhiá»u lá»±a chá»n gÃ³i theo nhu cáº§u cá»§a báº¡n
        </div>
        {renderPlans("ğŸ“¦ GÃ³i Ä‘Äƒng tin thÃªm", postPlans, "postPlans")}
        {renderPlans("â™»ï¸ GÃ³i gia háº¡n tin", renewPlans, "renewPlans")}
        {renderPlans(
          "ğŸš€ GÃ³i nÃ¢ng cáº¥p tin (VIP, Ná»•i báº­t, ÄÄƒng nhanh)",
          vipPlans,
          "vipPlans"
        )}
        {renderPlans(
          "ğŸ” Dá»‹ch vá»¥ cho ngÆ°á»i tÃ¬m phÃ²ng",
          seekerPlans,
          "seekerPlans"
        )}
        {renderPlans("ğŸ’¼ GÃ³i Pro chuyÃªn nghiá»‡p", plans, "plans")}
      </div>
      {/* Success Snackbar */}
      <Snackbar
        open={successOpen}
        autoHideDuration={4000}
        onClose={() => setSuccessOpen(false)}
        anchorOrigin={{ vertical: "top", horizontal: "center" }}
      >
        <Alert severity="success" onClose={() => setSuccessOpen(false)}>
          {successMessage}
        </Alert>
      </Snackbar>

      {/* Error Snackbar */}
      <Snackbar
        open={errorOpen}
        autoHideDuration={4000}
        onClose={() => setErrorOpen(false)}
        anchorOrigin={{ vertical: "top", horizontal: "center" }}
      >
        <Alert severity="error" onClose={() => setErrorOpen(false)}>
          {errorMessage}
        </Alert>
      </Snackbar>
    </Box>
  );
};

export default UpgradePlan;
