import React, { useRef, useEffect, useState } from "react";
import { useNavigate, useLocation } from "react-router-dom";
import { useDispatch } from "react-redux";
import {
  Box,
  Typography,
  Grid,
  Card,
  CardContent,
  Button,
  Accordion,
  AccordionSummary,
  AccordionDetails,
  ExpandMore,
  List,
  ListItem,
  ListItemIcon,
  ListItemText,
  duration,
  Snackbar,
  Alert,
} from "@mui/material";
import CheckIcon from "@mui/icons-material/Check";
import ExpandMoreIcon from "@mui/icons-material/ExpandMore";
import { refreshUser } from "../../../redux/apiRequest"
import "./UpgradePlan.css";

const plans = [
  {
    id: "proCaNhan",
    title: "G√≥i Pro C√° Nh√¢n",
    price: 199000,
    duration: "30 ng√†y",
    features: ["ƒêƒÉng 10 tin/th√°ng", "H·ªó tr·ª£ ∆∞u ti√™n", "Th·ªëng k√™ chi ti·∫øt"],
  },
  {
    id: "proDoanhNghiep",
    title: "G√≥i Pro Doanh Nghi·ªáp",
    price: 499000,
    duration: "30 ng√†y",
    features: ["ƒêƒÉng 50 tin/th√°ng", "H·ªó tr·ª£ 24/7", "Truy xu·∫•t API"],
  },
  {
    id: "proCaoCap",
    title: "G√≥i Pro Cao C·∫•p",
    price: 899000,
    duration: "30 ng√†y",
    features: ["ƒêƒÉng kh√¥ng gi·ªõi h·∫°n", "Qu·∫£n l√Ω ƒë·ªôi nh√≥m", "T∆∞ v·∫•n chi·∫øn l∆∞·ª£c"],
  },
];

const postPlans = [
  {
    id: "free3post",
    title: "3 tin mi·ªÖn ph√≠ / th√°ng",
    price: 0,
    features: ["ƒêƒÉng tin mi·ªÖn ph√≠ m·ªói th√°ng"],
    path: "#",
  },
  {
    id: "additional5post",
    title: "G√≥i 5 tin",
    price: 50000,
    duration: "30 ng√†y",
    features: ["ƒêƒÉng th√™m 5 tin"],
  },
  {
    id: "additionalunlimitedpost",
    title: "G√≥i kh√¥ng gi·ªõi h·∫°n",
    price: 100000,
    duration: "30 ng√†y",
    features: ["ƒêƒÉng kh√¥ng gi·ªõi h·∫°n tin"],
  },
];

const renewPlans = [
  {
    id: "renew7",
    title: "Gia h·∫°n 7 ng√†y",
    price: 10000,
    duration: "7 ng√†y",
    features: ["Gia h·∫°n tin th√™m 7 ng√†y"],
  },
  {
    id: "renew15",
    title: "Gia h·∫°n 15 ng√†y",
    price: 18000,
    duration: "15 ng√†y",
    features: ["Gia h·∫°n tin th√™m 15 ng√†y"],
  },
  {
    id: "renew30",
    title: "Gia h·∫°n 30 ng√†y",
    price: 30000,
    duration: "30 ng√†y",
    features: ["Gia h·∫°n tin th√™m 30 ng√†y"],
  },
];

const vipPlans = [
  {
    id: "vip7",
    title: "Tin VIP 7 ng√†y",
    price: 50000,
    duration: "7 ng√†y",
    features: ["∆Øu ti√™n t√¨m ki·∫øm", "Hi·ªÉn th·ªã ƒë·∫ßu trang"],
  },
  {
    id: "outstanding7",
    title: "Tin N·ªïi b·∫≠t 7 ng√†y",
    price: 30000,
    duration: "7 ng√†y",
    features: ["Bi·ªÉu t∆∞·ª£ng ƒë·∫∑c bi·ªát", "ƒê·∫©y ƒë·∫ßu chuy√™n m·ª•c"],
  },
  {
    id: "fastpost",
    title: "ƒêƒÉng tin nhanh",
    price: 20000,
    features: ["B·ªè ki·ªÉm duy·ªát", "ƒêƒÉng ngay l·∫≠p t·ª©c"],
  },
];

const seekerPlans = [
  {
    id: "viewphone",
    title: "Xem s·ªë ƒëi·ªán tho·∫°i",
    price: 5000,
    features: ["Hi·ªán s·ªë ng∆∞·ªùi ƒëƒÉng"],
  },
  {
    id: "unlimitedphone",
    title: "G√≥i xem kh√¥ng gi·ªõi h·∫°n",
    price: 50000,
    duration: "30 ng√†y",
    features: ["Xem s·ªë kh√¥ng gi·ªõi h·∫°n"],
  },
  {
    id: "findroomvip",
    title: "G√≥i th√†nh vi√™n t√¨m ph√≤ng",
    price: 79000,
    duration: "30 ng√†y",
    features: ["Kh√¥ng qu·∫£ng c√°o", "Xem SƒêT", "∆Øu ti√™n tin m·ªõi"],
  },
];

const UpgradePlan = () => {
  const navigate = useNavigate();
  const dispatch = useDispatch();
  const location = useLocation();
  const successMessage = location.state?.successMessage;
  const errorMessage = location.state?.errorMessage;
  const [successOpen, setSuccessOpen] = useState(false);
  const [errorOpen, setErrorOpen] = useState(false);
  const handleSelect = (plan) => {
    navigate(
      `/checkout?plan=${plan.id}&title=${encodeURIComponent(plan.title)}&duration=${plan.duration}&features=${plan.features}&price=${plan.price}`
    );
  };

  const plansSectionRef = useRef();

  const handleBuyNow = () => {
    if (plansSectionRef.current) {
      plansSectionRef.current.scrollIntoView({ behavior: "smooth" });
    }
  };

  const renderPlans = (title, plans) => (
    <Accordion
      sx={{
        mb: 2,
        border: "1px solid #e0e0e0",
        borderRadius: 2,
        boxShadow: "0 2px 8px rgba(0,0,0,0.05)",
        "&:before": { display: "none" },
      }}
    >
      <AccordionSummary
        expandIcon={<ExpandMoreIcon />}
        sx={{
          backgroundColor: "#f5f5f5",
          borderBottom: "1px solid #ddd",
          "& .MuiTypography-root": {
            fontWeight: 600,
          },
        }}
      >
        <Typography variant="h6">{title}</Typography>
      </AccordionSummary>
      <AccordionDetails sx={{ backgroundColor: "#e8f5e9", p: 3 }}>
        <Grid container spacing={3}>
          {plans.map((plan, index) => {
            const isGreen = index % 2 === 0;
            const cardBg = isGreen ? "#c8e6c9" : "#ffe0b2";
            const btnBg = isGreen ? "#43a047" : "#fb8c00";
            const btnHover = isGreen ? "#388e3c" : "#ef6c00";

            return (
              <Grid item xs={12} sm={6} md={4} key={plan.title}>
                <Card
                  sx={{
                    height: "100%",
                    display: "flex",
                    flexDirection: "column",
                    justifyContent: "space-between",
                    borderRadius: 2,
                    backgroundColor: cardBg,
                    boxShadow: "0 2px 12px rgba(0, 0, 0, 0.05)",
                    transition: "transform 0.2s",
                    "&:hover": {
                      transform: "scale(1.02)",
                    },
                  }}
                >
                  <CardContent
                    sx={{
                      display: "flex",
                      flexDirection: "column",
                      height: "100%",
                    }}
                  >
                    <Box sx={{ mb: 2 }}>
                      <Typography
                        variant="h6"
                        gutterBottom
                        sx={{ fontWeight: "bold" }}
                      >
                        {plan.title}
                      </Typography>
                      <Typography
                        variant="h4"
                        color="text.primary"
                        sx={{ fontWeight: "bold", mb: 2 }}
                      >
                        {Number(plan.price).toLocaleString()}ƒë
                      </Typography>

                      <List dense>
                        {plan.features.map((f, i) => (
                          <ListItem key={i} disableGutters sx={{ pl: 0 }}>
                            <ListItemIcon sx={{ minWidth: 28 }}>
                              <CheckIcon fontSize="small" color="success" />
                            </ListItemIcon>
                            <ListItemText primary={f} />
                          </ListItem>
                        ))}
                      </List>
                    </Box>

                    <Box sx={{ mt: "auto" }}>
                      <Button
                        fullWidth
                        variant="contained"
                        size="large"
                        sx={{
                          backgroundColor: btnBg,
                          "&:hover": { backgroundColor: btnHover },
                          borderRadius: 2,
                          fontWeight: "bold",
                        }}
                        onClick={() => handleSelect(plan)}
                      >
                        Ch·ªçn g√≥i
                      </Button>
                    </Box>
                  </CardContent>
                </Card>
              </Grid>
            );
          })}
        </Grid>
      </AccordionDetails>
    </Accordion>
  );

  useEffect(() => {
    if (successMessage) {
      setSuccessOpen(true);
    }
    if (errorMessage) {
      setErrorOpen(true);
    }
  }, [successMessage, errorMessage]);
  
  useEffect(() => {
    refreshUser(dispatch);
  }, []);  

  return (
    <Box className="upgrade-plan-container">
      {/* Banner gi·ªõi thi·ªáu g√≥i Pro */}
      <div className="promo-banner">
        <div className="promo-content">
          <img
            src="https://static.chotot.com/storage/default_images/pty/subscription_landing_page/pty-sub-goi-pro-logo.png"
            width="64"
            height="40"
            alt="goi-pro-logo"
          />
          <p className="promo-text">
            G√≥i ƒëƒÉng tin cho m√¥i gi·ªõi BƒêS chuy√™n nghi·ªáp - Ti·∫øt ki·ªám ƒë·∫øn 86%
          </p>
          <ul className="promo-list">
            <li className="promo-item">
              <div className="promo-icon">‚úì</div>Ti·∫øt ki·ªám ƒë·∫øn 86% ph√≠ ƒëƒÉng tin
            </li>
            <li className="promo-item">
              <div className="promo-icon">‚úì</div>Th√™m k√™nh thu h√∫t kh√°ch h√†ng c√≥
              nhu c·∫ßu th·ª±c
            </li>
            <li className="promo-item">
              <div className="promo-icon">‚úì</div>Qu·∫£n l√Ω kinh doanh v√† chi ti√™u
              hi·ªáu qu·∫£
            </li>
          </ul>
          <div className="promo-buttons">
            <button className="btn btn-primary" onClick={() => handleBuyNow()}>
              Mua ngay
            </button>
            <button
              className="btn btn-outline"
              onClick={() => alert("T∆∞ v·∫•n th√™m")}
            >
              T√¥i c·∫ßn t∆∞ v·∫•n
            </button>
          </div>
        </div>
        <div className="promo-image">
          <img
            src="https://static.chotot.com/storage/default_images/pty/subscription_landing_page/pty-sub-value.png"
            alt="goi-pro-img"
          />
        </div>
      </div>

      <div ref={plansSectionRef}>
        <div className="upgrade-title">
          Nhi·ªÅu l·ª±a ch·ªçn g√≥i theo nhu c·∫ßu c·ªßa b·∫°n
        </div>
        {renderPlans("üì¶ G√≥i ƒëƒÉng tin th√™m", postPlans, "postPlans")}
        {renderPlans("‚ôªÔ∏è G√≥i gia h·∫°n tin", renewPlans, "renewPlans")}
        {renderPlans(
          "üöÄ G√≥i n√¢ng c·∫•p tin (VIP, N·ªïi b·∫≠t, ƒêƒÉng nhanh)",
          vipPlans,
          "vipPlans"
        )}
        {renderPlans(
          "üîç D·ªãch v·ª• cho ng∆∞·ªùi t√¨m ph√≤ng",
          seekerPlans,
          "seekerPlans"
        )}
        {renderPlans("üíº G√≥i Pro chuy√™n nghi·ªáp", plans, "plans")}
      </div>
      {/* Success Snackbar */}
      <Snackbar
        open={successOpen}
        autoHideDuration={4000}
        onClose={() => setSuccessOpen(false)}
        anchorOrigin={{ vertical: "top", horizontal: "center" }}
      >
        <Alert severity="success" onClose={() => setSuccessOpen(false)}>
          {successMessage}
        </Alert>
      </Snackbar>

      {/* Error Snackbar */}
      <Snackbar
        open={errorOpen}
        autoHideDuration={4000}
        onClose={() => setErrorOpen(false)}
        anchorOrigin={{ vertical: "top", horizontal: "center" }}
      >
        <Alert severity="error" onClose={() => setErrorOpen(false)}>
          {errorMessage}
        </Alert>
      </Snackbar>
    </Box>
  );
};

export default UpgradePlan;
